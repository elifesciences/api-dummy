#!/usr/bin/env php
<?php

use eLife\ApiClient\ApiClient\ArticlesClient;
use eLife\ApiClient\HttpClient\Guzzle6HttpClient;
use eLife\ApiClient\Result;
use GuzzleHttp\Client;
use GuzzleHttp\Promise\Utils;
use Symfony\Component\Filesystem\Filesystem;

require_once __DIR__.'/../vendor/autoload.php';

if (empty($argv[1]) || !preg_match('/[a-z0-9-]+/', $argv[1])) {
    throw new InvalidArgumentException(sprintf('Article ID expected: %s given', empty($argv[1]) ? 'none' : $argv[1]));
}

if (!empty($argv[2]) && !in_array($argv[2], ['prod', 'continuumtest'])) {
    throw new InvalidArgumentException(sprintf('Gateway expected: %s given', $argv[2]));
}

$gateway = $argv[2] ?? 'prod';

$api_key = $argv[3] ?? null;

$config = [
    'base_uri' => 'https://'.$gateway.'--gateway.elifesciences.org/',
];

if (!empty($api_key)) {
    $config['headers'] = [
        'Authorization' => $api_key,
    ];
}

$guzzle = new Client($config);

$client = new Guzzle6HttpClient($guzzle);

$articlesClient = new ArticlesClient($client);

$articleId = $argv[1];

$history = [];

$versions = Utils::all(
    $articlesClient->getArticleHistory([], $articleId)
        ->then(function (Result $result) use (&$history) {
            $history = $result->toArray();
            return $history['versions'];
        })
        ->then(function (array $versions) {
            return array_filter($versions, function (array $version) {
                return !empty($version['version']);
            });
        })
        ->then(function (array $versions) use ($articleId, $articlesClient) {
            return array_map(function (array $version) use ($articleId, $articlesClient) {
                return $articlesClient->getArticleVersion([], $articleId, $version['version'])
                    ->then(function (Result $result) {
                        return $result->toArray();
                    })->wait();
            }, $versions);
        })
        ->wait()
)->wait();

$indexVersions = [];
foreach ($versions as $version) {
    $indexVersions[$version['version']] = $version;
}

foreach ($history['versions'] as $k => $version) {
    if (!empty($version['version'])) {
        $history['versions'][$k] = $indexVersions[$version['version']];
    }
}

$data = json_encode($history, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);

$fs = new Filesystem();
$dataFile = __DIR__.'/../data/articles/'.$articleId.'.json';
$fs->touch($dataFile);
$fs->dumpFile($dataFile, $data.PHP_EOL);
